#!/usr/bin/env bash
# filepath: /etc/zfs-setup.conf
# ZFS Scripts Configuration File
# Version: 2.2
# Date: 2025-12-10
# Description: Central configuration for all ZFS management scripts
#
# This file contains all paths, settings, and configurations used by:
# - zfs-void-install-new.sh (installation)
# - zfs-health-check.sh (health monitoring)
# - zfs-services-manager.sh (service management)
# - zfs-pre-checks.sh (pre-update validation)
# - zfs-install-updates.sh (system updates)
# - zfs-post-update-verify.sh (post-update verification)
#
# IMPORTANT: Do not modify unless you know what you're doing!
# Changes here affect ALL ZFS management scripts.
#
# Reference: Based on zfs-void-install-new.sh v3.0

# ============================================
# SCRIPT METADATA
# ============================================
CONFIG_VERSION="2.2"
CONFIG_DATE="2025-12-10"
CONFIG_NAME="zfs-setup.conf"

# ============================================
# VOID LINUX REPOSITORY CONFIGURATION
# ============================================
# Official Void Linux repository
REPO="https://repo-default.voidlinux.org/current"

# System architecture
# Options: x86_64, i686, aarch64, armv7l, armv6l
ARCH="x86_64"

# ============================================
# ZFS CORE FILE PATHS
# ============================================
# ZFS encryption key file
# Used for encrypted pool/dataset access
# Permission: 000 (no access - most secure)
# Location: Must be in /etc/zfs/ for dracut inclusion
ZFS_KEY_FILE="/etc/zfs/zroot.key"

# ZFS pool cache file
# Contains imported pool information
# Auto-generated by ZFS on pool import
# Permission: 644 (root read/write, others read)
ZFS_CACHE_FILE="/etc/zfs/zpool.cache"

# System host ID file
# Critical for ZFS pool import
# Must be exactly 4 bytes
# Generated by: zgenhostid -f
ZFS_HOSTID_FILE="/etc/hostid"

# ZFS key backup directory
# Store backup copies of encryption keys
# Permission: 700 (root only)
ZFS_KEY_BACKUP_DIR="/root/zfs-keys"

# ZFS configuration directory
ZFS_CONFIG_DIR="/etc/zfs"

# ============================================
# ZFS POOL CONFIGURATION
# ============================================
# Default pool name for installation
DEFAULT_POOL_NAME="zroot"

# Pool properties
# ashift: Sector size alignment (12 = 4K sectors, recommended for modern drives)
POOL_ASHIFT="12"

# autotrim: Automatic TRIM for SSDs
# Options: on, off
POOL_AUTOTRIM="on"

# ============================================
# ZFS ENCRYPTION CONFIGURATION
# ============================================
# Encryption algorithm
# Options: aes-128-ccm, aes-192-ccm, aes-256-ccm, aes-128-gcm, aes-192-gcm, aes-256-gcm
# Recommended: aes-256-gcm (best security and performance on modern CPUs with AES-NI)
ENCRYPTION_ALGORITHM="aes-256-gcm"

# Key format
# Options: raw, hex, passphrase
# Recommended: passphrase (most user-friendly)
KEY_FORMAT="passphrase"

# Key location during installation
# Options: prompt, file:///path/to/key
# Installation uses: file:///etc/zfs/zroot.key
# Runtime can use: prompt (more secure)
KEY_LOCATION_INSTALL="file:///etc/zfs/zroot.key"
KEY_LOCATION_RUNTIME="prompt"

# ============================================
# ZFS DATASET PROPERTIES (POOL-LEVEL)
# ============================================
# ACL type
# Options: off, posixacl
# Recommended: posixacl (for Linux compatibility)
DATASET_ACLTYPE="posixacl"

# Compression algorithm
# Options: off, lz4, gzip, gzip-[1-9], zstd, zstd-[1-19], zle, lzjb
# Recommended: lz4 (best balance of speed and compression)
DATASET_COMPRESSION="lz4"

# Relative time updates
# Options: on, off
# Recommended: on (reduces write load while maintaining compatibility)
DATASET_RELATIME="on"

# Extended attributes
# Options: off, sa (system attribute), on (directory)
# Recommended: sa (better performance)
DATASET_XATTR="sa"

# Variable dnode size
# Options: legacy, auto, 1k, 2k, 4k, 8k, 16k
# Recommended: auto (allows flexibility for large xattrs)
DATASET_DNODESIZE="auto"

# Unicode normalization
# Options: none, formC, formD, formKC, formKD
# Recommended: formD (compatibility with macOS and some applications)
DATASET_NORMALIZATION="formD"

# Device nodes
# Options: on, off
# Recommended: off (security - prevents device node creation)
DATASET_DEVICES="off"

# Default mountpoint for pool
# Recommended: none (datasets set their own mountpoints)
DATASET_MOUNTPOINT="none"

# Default canmount for pool
# Options: on, off, noauto
# Recommended: off (datasets set their own canmount)
DATASET_CANMOUNT="off"

# ============================================
# ZFS DATASET STRUCTURE
# ============================================
# Root container dataset
ROOT_CONTAINER="ROOT"

# Root container properties
ROOT_CONTAINER_MOUNTPOINT="none"
ROOT_CONTAINER_CANMOUNT="off"

# Boot environment (root) dataset properties
BOOT_ENV_MOUNTPOINT="/"
BOOT_ENV_CANMOUNT="noauto"
BOOT_ENV_RECORDSIZE="128K"
BOOT_ENV_ATIME="off"
BOOT_ENV_RELATIME="off"
BOOT_ENV_DEVICES="off"

# Data container dataset
DATA_CONTAINER="data"
DATA_CONTAINER_MOUNTPOINT="none"
DATA_CONTAINER_CANMOUNT="off"

# Home dataset properties
HOME_DATASET_MOUNTPOINT="/home"
HOME_DATASET_RECORDSIZE="1M"
HOME_DATASET_COMPRESSION="zstd-3"
HOME_DATASET_ATIME="off"

# Root home dataset properties
ROOT_HOME_DATASET_MOUNTPOINT="/root"
ROOT_HOME_DATASET_RECORDSIZE="128K"
ROOT_HOME_DATASET_COMPRESSION="zstd"

# ============================================
# ZFS SWAP CONFIGURATION
# ============================================
# Swap zvol properties
SWAP_COMPRESSION="zle"
SWAP_LOGBIAS="throughput"
SWAP_SYNC="disabled"
SWAP_PRIMARYCACHE="metadata"
SWAP_SECONDARYCACHE="none"
SWAP_AUTO_SNAPSHOT="false"

# Default swap size (can be overridden by user input)
# Format: number + G (gigabytes) or M (megabytes)
# Examples: "4G", "8G", "16G"
DEFAULT_SWAP_SIZE="4G"

# ============================================
# CONFIGURATION FILE PATHS
# ============================================
# Dracut configuration files
DRACUT_CONF="/etc/dracut.conf"
DRACUT_CONF_DIR="/etc/dracut.conf.d"
DRACUT_ZFS_CONF="${DRACUT_CONF_DIR}/zfs.conf"

# ZFSBootMenu configuration files
ZBM_CONFIG="/etc/zfsbootmenu/config.yaml"
ZBM_DRACUT_DIR="/etc/zfsbootmenu/dracut.conf.d"
ZBM_KEYMAP_CONF="${ZBM_DRACUT_DIR}/keymap.conf"

# Kernel command line directory
CMDLINE_DIR="/etc/cmdline.d"
CMDLINE_KEYMAP_CONF="${CMDLINE_DIR}/keymap.conf"

# System configuration files
RC_CONF="/etc/rc.conf"
FSTAB="/etc/fstab"
SYSCTL_CONF="/etc/sysctl.conf"
RESOLVCONF_CONF="/etc/resolvconf.conf"
IWD_CONF_DIR="/etc/iwd"
IWD_CONF="${IWD_CONF_DIR}/main.conf"

# Sudo configuration
SUDOERS_DIR="/etc/sudoers.d"
SUDOERS_WHEEL_FILE="${SUDOERS_DIR}/99-wheel"

# Gummiboot configuration
GUMMIBOOT_CONF="/etc/default/gummiboot"

# ============================================
# EFI/BOOT PARTITION CONFIGURATION
# ============================================
# ESP mount point
ESP_MOUNT="/boot/efi"

# ZFSBootMenu EFI directory
ZBM_EFI_DIR="${ESP_MOUNT}/EFI/ZBM"

# ZFSBootMenu EFI images
ZBM_EFI_IMAGE="${ZBM_EFI_DIR}/vmlinuz.efi"
ZBM_EFI_BACKUP="${ZBM_EFI_DIR}/vmlinuz-backup.efi"

# EFI partition size
EFI_SIZE="512M"

# EFI partition type GUID
EFI_TYPE="EF00"

# EFI filesystem type
EFI_FSTYPE="vfat"

# EFI filesystem label
EFI_LABEL="EFI"

# EFI partition number (typically 1)
EFI_PARTITION_NUM="1"

# ZFS partition type GUID
ZFS_TYPE="BF00"

# ZFS partition number (typically 2)
ZFS_PARTITION_NUM="2"

# ============================================
# SYSTEM LOCALE AND KEYBOARD
# ============================================
# System locale
SYSTEM_LOCALE="en_US.UTF-8"

# Locale generation
LOCALE_GEN="en_US.UTF-8 UTF-8"

# Console keymap
CONSOLE_KEYMAP="us"

# Console font
CONSOLE_FONT="drdos8x16"

# Hardware clock
HARDWARE_CLOCK="UTC"

# Default timezone
DEFAULT_TIMEZONE="Asia/Singapore"

# ============================================
# NETWORK CONFIGURATION
# ============================================
# DNS nameservers
DNS_NAMESERVERS="1.1.1.1 9.9.9.9"

# ============================================
# SYSTEM SERVICES (RUNIT)
# ============================================
# Runit service directory
RUNSVDIR="/etc/runit/runsvdir/default"

# Service source directory
SV_DIR="/etc/sv"

# Essential system services
ESSENTIAL_SERVICES=(
    "dhcpcd"
    "iwd"
    "chronyd"
    "crond"
    "dbus"
    "acpid"
    "elogind"
    "polkitd"
)

# ZFS services
ZFS_SERVICES=(
    "zfs-import"
    "zfs-mount"
    "zfs-zed"
)

# ============================================
# SYSTEM USER CONFIGURATION
# ============================================
# Default user groups
USER_GROUPS="network,wheel,video,audio,input,kvm"

# ============================================
# REQUIRED PACKAGES
# ============================================
# Base system
BASE_PACKAGES=(
    "base-system"
    "void-repo-nonfree"
)

# ZFS and boot packages
ZFS_PACKAGES=(
    "zfs"
    "zfsbootmenu"
    "efibootmgr"
    "gummiboot"
    "dracut"
)

# Network packages
NETWORK_PACKAGES=(
    "iwd"
    "dhcpcd"
    "openresolv"
)

# System services packages
SERVICE_PACKAGES=(
    "chrony"
    "elogind"
    "polkit-elogind"
    "cronie"
    "acpid"
)

# Essential utilities
UTILITY_PACKAGES=(
    "git"
)

# All required packages (combined)
REQUIRED_PACKAGES=(
    "${BASE_PACKAGES[@]}"
    "${ZFS_PACKAGES[@]}"
    "${NETWORK_PACKAGES[@]}"
    "${SERVICE_PACKAGES[@]}"
    "${UTILITY_PACKAGES[@]}"
)

# ============================================
# SYSTEM REQUIREMENTS
# ============================================
# Minimum passphrase length
MIN_PASSPHRASE_LENGTH="8"

# Minimum password length
MIN_PASSWORD_LENGTH="6"

# Hostid file size (must be exactly 4 bytes)
HOSTID_SIZE="4"

# ============================================
# CHROOT BIND MOUNTS
# ============================================
# Directories to bind mount for chroot
CHROOT_BIND_MOUNTS=(
    "/sys"
    "/dev"
    "/proc"
)

# ============================================
# LOG FILES AND DIRECTORIES
# ============================================
# Log directory
LOG_DIR="/var/log"

# Installation log file
INSTALL_LOG="${LOG_DIR}/zfs-void-install.log"

# Health check log pattern
HEALTH_LOG_PATTERN="${LOG_DIR}/zfs-health-check-*.log"

# Pre-checks log pattern
PRECHECK_LOG_PATTERN="${LOG_DIR}/zfs-pre-checks-*.log"

# Post-verification log pattern
POSTVERIFY_LOG_PATTERN="${LOG_DIR}/zfs-post-verify-*.log"

# ============================================
# VALIDATION PATTERNS
# ============================================
# Valid hostname pattern
HOSTNAME_PATTERN="^[a-zA-Z0-9-]+$"

# Valid username pattern
USERNAME_PATTERN="^[a-z_][a-z0-9_-]*$"

# Reserved usernames
RESERVED_USERNAMES=("root" "nobody")

# Valid dataset name pattern
DATASET_NAME_PATTERN="^[a-zA-Z0-9_-]+$"

# Valid swap size pattern
SWAP_SIZE_PATTERN="^[0-9]+[GMgm]$"

# ============================================
# TIMEOUT AND RETRY SETTINGS
# ============================================
# Maximum wait time for device appearance (seconds)
DEVICE_WAIT_TIMEOUT="30"

# Sleep interval for device checks (seconds)
DEVICE_CHECK_INTERVAL="1"

# ZFS cache generation wait time (seconds)
ZPOOL_CACHE_WAIT="2"

# Pool export retry attempts
POOL_EXPORT_RETRIES="3"

# ============================================
# GUMMIBOOT CONFIGURATION
# ============================================
# Gummiboot post-install hook disable flag
GUMMIBOOT_DISABLE="1"

# ============================================
# INITRAMFS CONFIGURATION
# ============================================
# Initramfs directory
INITRAMFS_DIR="/boot"

# Initramfs filename pattern
INITRAMFS_PATTERN="initramfs-*.img"

# ============================================
# ZFS HEALTH CHECK SETTINGS
# ============================================
# Scrub age warning threshold (days)
SCRUB_AGE_WARNING="30"

# Scrub age critical threshold (days)
SCRUB_AGE_CRITICAL="90"

# Pool capacity warning threshold (percentage)
POOL_CAPACITY_WARNING="80"

# Pool capacity critical threshold (percentage)
POOL_CAPACITY_CRITICAL="90"

# ============================================
# BACKUP AND RECOVERY
# ============================================
# Backup retention
KEEP_BACKUPS="3"

# Snapshot prefix
SNAPSHOT_PREFIX="backup"

# ============================================
# DEBUGGING AND DEVELOPMENT
# ============================================
# Enable debug mode
DEBUG_MODE="false"

# Verbose logging
VERBOSE_MODE="false"

# Dry run mode (for testing)
DRY_RUN="false"

# ============================================
# SCRIPT PATHS
# ============================================
# Script library directory
LIB_DIR="/usr/local/lib/zfs-scripts"

# Common library
COMMON_LIB="${LIB_DIR}/common.sh"

# Scripts directory
SCRIPTS_DIR="/usr/local/bin"

# ============================================
# VERSION INFORMATION
# ============================================
# Expected ZFS version (minimum)
MIN_ZFS_VERSION="2.1.0"

# Expected ZFSBootMenu version (minimum)
MIN_ZBM_VERSION="2.2.0"

# Expected dracut version (minimum)
MIN_DRACUT_VERSION="055"

# ============================================
# TEMPORARY FILES AND DIRECTORIES
# ============================================
# Temporary swap creation flag
SWAP_CREATED_FLAG="/tmp/swap_created"

# Temporary mount point
TEMP_MOUNT="/mnt"

# ============================================
# FILE CONTENT TEMPLATES
# All configuration files use consistent template approach
# Usage: cat > /path/to/file <<EOF
#        ${TEMPLATE_NAME}
#        EOF
# ============================================

# /etc/dracut.conf.d/zfs.conf
read -r -d '' DRACUT_ZFS_CONF_CONTENT <<'EOF' || true
add_dracutmodules+=" zfs "
omit_dracutmodules+=" btrfs lvm dm crypt-loop resume "
kernel_cmdline="ro quiet loglevel=0"
install_items+=" /etc/zfs/zroot.key /etc/hostid "
install_optional_items+=" /sbin/zfs /sbin/zpool /sbin/mount.zfs "
EOF

# /etc/dracut.conf
read -r -d '' DRACUT_CONF_CONTENT <<'EOF' || true
hostonly="yes"
hostonly_cmdline="yes"
compress="zstd"
early_microcode="yes"
persistent_policy="by-uuid"
show_modules="yes"
omit_dracutmodules+=" network plymouth "
EOF

# /etc/rc.conf (requires SYSTEM_TIMEZONE variable substitution)
# Usage: eval "cat <<EOF
#        ${RC_CONF_CONTENT}
#        EOF"
read -r -d '' RC_CONF_CONTENT <<'EOF' || true
TIMEZONE="${SYSTEM_TIMEZONE}"
HARDWARECLOCK="UTC"
KEYMAP="us"
FONT="drdos8x14"
EOF

# /etc/iwd/main.conf
read -r -d '' IWD_CONF_CONTENT <<'EOF' || true
[General]
UseDefaultInterface=true
EnableNetworkConfiguration=true

[Network]
NameResolvingService=resolvconf
EOF

# /etc/resolvconf.conf
read -r -d '' RESOLVCONF_CONF_CONTENT <<'EOF' || true
resolv_conf=/etc/resolv.conf
name_servers="1.1.1.1 9.9.9.9"
EOF

# /etc/sysctl.conf
read -r -d '' SYSCTL_CONF_CONTENT <<'EOF' || true
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
EOF

# /etc/fstab (requires EFI_UUID variable substitution)
# Usage: eval "cat <<EOF
#        ${FSTAB_CONTENT}
#        EOF"
read -r -d '' FSTAB_CONTENT <<'EOF' || true
# <file system>              <mount point>  <type>  <options>                        <dump> <pass>
UUID=${EFI_UUID}               /boot/efi      vfat    defaults,noatime                 0      2
tmpfs                        /tmp           tmpfs   defaults,nosuid,nodev,mode=1777  0      0
tmpfs                        /dev/shm       tmpfs   defaults,nosuid,nodev,noexec     0      0
efivarfs                     /sys/firmware/efi/efivars efivarfs defaults              0      0
EOF

# /etc/sudoers.d/99-wheel
read -r -d '' SUDOERS_WHEEL_CONTENT <<'EOF' || true
## Allow members of group wheel to execute any command
%wheel ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command without password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL
EOF

# /etc/zfsbootmenu/config.yaml
read -r -d '' ZBM_CONFIG_CONTENT <<'EOF' || true
Global:
  ManageImages: true
  BootMountPoint: /boot/efi
  DracutConfDir: /etc/zfsbootmenu/dracut.conf.d
Components:
  Enabled: false
EFI:
  Enabled: true
  ImageDir: /boot/efi/EFI/ZBM
  Versions: false
Kernel:
  Prefix: vmlinuz
EOF

# /etc/zfsbootmenu/dracut.conf.d/keymap.conf
read -r -d '' ZBM_KEYMAP_CONF_CONTENT <<'EOF' || true
install_optional_items+=" /etc/cmdline.d/keymap.conf "
EOF

# /etc/cmdline.d/keymap.conf
read -r -d '' CMDLINE_KEYMAP_CONF_CONTENT <<'EOF' || true
rd.vconsole.keymap=us
EOF

# /etc/default/gummiboot
# Usage: eval "cat <<EOF
#        ${GUMMIBOOT_CONF_CONTENT}
#        EOF"
read -r -d '' GUMMIBOOT_CONF_CONTENT <<'EOF' || true
GUMMIBOOT_DISABLE=${GUMMIBOOT_DISABLE}
EOF

# ============================================
# END OF CONFIGURATION
# ============================================

# Export all variables for use in other scripts
set -a
# Variables are already set above, this just marks them for export
set +a

# Configuration loaded successfully
return 0
