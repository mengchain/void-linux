#!/usr/bin/env bash
# ZFS Scripts Configuration File
# Version: 2.5
# Date: 2025-12-12
# ALIGNED WITH: zfs-void-install.sh v3.0
# 
# This configuration file contains ONLY key-value pairs and templates.
# All functions are located in common.sh and individual scripts.

# ============================================
# SCRIPT METADATA
# ============================================
CONFIG_VERSION="2.5"
CONFIG_DATE="2025-12-12"
CONFIG_NAME="zfs-setup.conf"
INSTALLATION_SCRIPT_VERSION="3.0"

# ============================================
# VOID LINUX REPOSITORY CONFIGURATION
# ============================================
REPO="https://repo-default.voidlinux.org/current"
ARCH="x86_64"

# ============================================
# ZFS CORE FILE PATHS
# ============================================
ZFS_CONFIG_DIR="/etc/zfs"
ZFS_HOSTID_FILE="/etc/hostid"
ZFS_KEY_BACKUP_DIR="/root/zfs-keys"

# Pool-specific file path patterns
# Scripts will substitute {{POOL_NAME}} with actual pool name
ZFS_KEY_FILE_PATTERN="/etc/zfs/{{POOL_NAME}}.key"
ZFS_CACHE_FILE_PATTERN="/etc/zfs/{{POOL_NAME}}.cache"

# ============================================
# DRACUT CONFIGURATION PATHS
# ============================================
DRACUT_CONF="/etc/dracut.conf"
DRACUT_CONF_DIR="/etc/dracut.conf.d"
DRACUT_ZFS_CONF="/etc/dracut.conf.d/zfs.conf"

# ============================================
# BOOT CONFIGURATION PATHS
# ============================================
ESP_MOUNT="/boot/efi"
INITRAMFS_DIR="/boot"

# ZFSBootMenu paths
ZBM_CONFIG="/etc/zfsbootmenu/config.yaml"
ZBM_EFI_DIR="/boot/efi/EFI/ZBM"
ZBM_DRACUT_DIR="/etc/zfsbootmenu/dracut.conf.d"
ZBM_KEYMAP_CONF="/etc/zfsbootmenu/dracut.conf.d/keymap.conf"

# Kernel command line
CMDLINE_DIR="/etc/cmdline.d"
CMDLINE_KEYMAP_CONF="/etc/cmdline.d/keymap.conf"

# ============================================
# SYSTEM CONFIGURATION FILE PATHS
# ============================================
FSTAB="/etc/fstab"
RC_CONF="/etc/rc.conf"
IWD_CONF="/etc/iwd/main.conf"
RESOLVCONF_CONF="/etc/resolvconf.conf"
SYSCTL_CONF="/etc/sysctl.conf"
SUDOERS_WHEEL_FILE="/etc/sudoers.d/99-wheel"
LOCALE_CONF="/etc/locale.conf"
VCONSOLE_CONF="/etc/vconsole.conf"
LIBC_LOCALES="/etc/default/libc-locales"
GUMMIBOOT_DEFAULT="/etc/default/gummiboot"

# ============================================
# ZFS PROPERTY DEFAULTS
# From installation script lines 512-528
# ============================================

# Pool properties (line 512-513)
POOL_ASHIFT="12"
POOL_AUTOTRIM="on"

# Base dataset properties (lines 514-521)
DATASET_ACLTYPE="posixacl"
DATASET_COMPRESSION="lz4"
DATASET_RELATIME="on"
DATASET_XATTR="sa"
DATASET_DNODESIZE="auto"
DATASET_NORMALIZATION="formD"
DATASET_MOUNTPOINT="none"
DATASET_CANMOUNT="off"
DATASET_DEVICES="off"

# Encryption properties (lines 522-524)
ENCRYPTION_ALGORITHM="aes-256-gcm"
KEY_FORMAT="passphrase"
KEY_LOCATION_PATTERN="file:///etc/zfs/{{POOL_NAME}}.key"

# Root dataset properties (lines 537-541)
BOOT_ENV_MOUNTPOINT="/"
BOOT_ENV_CANMOUNT="noauto"
BOOT_ENV_RECORDSIZE="128K"
BOOT_ENV_ATIME="off"
BOOT_ENV_RELATIME="off"

# Home dataset properties (lines 570-573)
HOME_DATASET_MOUNTPOINT="/home"
HOME_DATASET_RECORDSIZE="1M"
HOME_DATASET_COMPRESSION="zstd-3"
HOME_DATASET_ATIME="off"

# Root home dataset properties (lines 574-576)
ROOT_HOME_MOUNTPOINT="/root"
ROOT_HOME_RECORDSIZE="128K"
ROOT_HOME_COMPRESSION="zstd"

# Swap zvol properties (lines 583-590)
SWAP_COMPRESSION="zle"
SWAP_LOGBIAS="throughput"
SWAP_SYNC="disabled"
SWAP_PRIMARYCACHE="metadata"
SWAP_SECONDARYCACHE="none"
SWAP_AUTO_SNAPSHOT="false"

# ZFSBootMenu properties (line 1151)
ZBM_COMMANDLINE_PROPERTY="ro quiet nowatchdog loglevel=0 zbm.timeout=5"

# ============================================
# DATASET STRUCTURE
# ============================================
ROOT_CONTAINER="ROOT"
DATA_CONTAINER="data"

# ============================================
# HEALTH CHECK THRESHOLDS
# ============================================
CAPACITY_WARNING="80"
CAPACITY_CRITICAL="90"
FRAGMENTATION_WARNING="50"
FRAGMENTATION_CRITICAL="70"
SCRUB_MAX_AGE_DAYS="30"
MAX_SNAPSHOTS_PER_DATASET="1000"

# ============================================
# SYSTEM DEFAULTS
# ============================================
DEFAULT_LOCALE="en_US.UTF-8"
DEFAULT_KEYMAP="us"
DEFAULT_FONT="drdos8x14"
DEFAULT_HARDWARECLOCK="UTC"
DEFAULT_DNS_SERVERS="1.1.1.1 9.9.9.9"

# ============================================
# RUNIT SERVICES
# From installation script lines 1011-1024
# ============================================

# Essential services (space-separated list)
ESSENTIAL_SERVICES="dhcpcd iwd chronyd crond dbus acpid elogind polkitd"

# ZFS services (space-separated list)
ZFS_SERVICES="zfs-import zfs-mount zfs-zed"

# ============================================
# CONFIGURATION CONTENT TEMPLATES
# Extracted directly from zfs-void-install.sh
# Placeholders use {{VARIABLE_NAME}} format
# ============================================

# ------------------------------
# DRACUT MAIN CONFIGURATION
# From lines 977-986
# ------------------------------
read -r -d '' DRACUT_CONF_CONTENT <<'TEMPLATE_EOF'
# Global dracut configuration
hostonly="yes"
hostonly_cmdline="yes"
compress="zstd"
early_microcode="yes"
persistent_policy="by-uuid"
show_modules="yes"
omit_dracutmodules+=" network plymouth "
TEMPLATE_EOF

# ------------------------------
# DRACUT ZFS CONFIGURATION
# From lines 967-973
# Placeholders: {{POOL_KEYS}}, {{HOSTID_FILE}}
# ------------------------------
read -r -d '' DRACUT_ZFS_CONF_TEMPLATE <<'TEMPLATE_EOF'
add_dracutmodules+=" zfs "
omit_dracutmodules+=" btrfs lvm dm crypt-loop resume "
kernel_cmdline="ro quiet loglevel=0"
install_items+=" {{POOL_KEYS}} {{HOSTID_FILE}} "
install_optional_items+=" /sbin/zfs /sbin/zpool /sbin/mount.zfs "
TEMPLATE_EOF

# ------------------------------
# IWD CONFIGURATION
# From lines 929-935
# ------------------------------
read -r -d '' IWD_CONF_CONTENT <<'TEMPLATE_EOF'
[General]
UseDefaultInterface=true
EnableNetworkConfiguration=true

[Network]
NameResolvingService=resolvconf
TEMPLATE_EOF

# ------------------------------
# RESOLVCONF CONFIGURATION
# From lines 938-941
# ------------------------------
read -r -d '' RESOLVCONF_CONF_CONTENT <<'TEMPLATE_EOF'
resolv_conf=/etc/resolv.conf
name_servers="1.1.1.1 9.9.9.9"
TEMPLATE_EOF

# ------------------------------
# SYSCTL CONFIGURATION
# From lines 944-948
# ------------------------------
read -r -d '' SYSCTL_CONF_CONTENT <<'TEMPLATE_EOF'
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
TEMPLATE_EOF

# ------------------------------
# RC.CONF ADDITIONS
# From lines 956-961
# Placeholders: {{TIMEZONE}}, {{HARDWARECLOCK}}, {{KEYMAP}}, {{FONT}}
# ------------------------------
read -r -d '' RC_CONF_TEMPLATE <<'TEMPLATE_EOF'
TIMEZONE="{{TIMEZONE}}"
HARDWARECLOCK="{{HARDWARECLOCK}}"
KEYMAP="{{KEYMAP}}"
FONT="{{FONT}}"
TEMPLATE_EOF

# ------------------------------
# LOCALE CONFIGURATION
# From lines 951-953
# ------------------------------
LIBC_LOCALES_CONTENT='en_US.UTF-8 UTF-8'
LOCALE_CONF_CONTENT='LANG="en_US.UTF-8"'
VCONSOLE_CONF_CONTENT='KEYMAP="us"'

# ------------------------------
# GUMMIBOOT DISABLE
# From line 887
# ------------------------------
GUMMIBOOT_DEFAULT_CONTENT='GUMMIBOOT_DISABLE=1'

# ------------------------------
# FSTAB CONFIGURATION
# From lines 1075-1087
# Placeholders: {{EFI_UUID}}, {{POOL_NAME}}
# ------------------------------
FSTAB_HEADER='# <file system>              <mount point>  <type>  <options>                        <dump> <pass>'

read -r -d '' FSTAB_EFI_TEMPLATE <<'TEMPLATE_EOF'
UUID={{EFI_UUID}}               /boot/efi      vfat    defaults,noatime                 0      2
TEMPLATE_EOF

read -r -d '' FSTAB_TMP_ENTRY <<'TEMPLATE_EOF'
tmpfs                        /tmp           tmpfs   defaults,nosuid,nodev,mode=1777  0      0
TEMPLATE_EOF

read -r -d '' FSTAB_SHM_ENTRY <<'TEMPLATE_EOF'
tmpfs                        /dev/shm       tmpfs   defaults,nosuid,nodev,noexec     0      0
TEMPLATE_EOF

read -r -d '' FSTAB_EFIVARFS_ENTRY <<'TEMPLATE_EOF'
efivarfs                     /sys/firmware/efi/efivars efivarfs defaults              0      0
TEMPLATE_EOF

read -r -d '' FSTAB_SWAP_TEMPLATE <<'TEMPLATE_EOF'
/dev/zvol/{{POOL_NAME}}/swap  none           swap    defaults,pri=100                 0      0
TEMPLATE_EOF

# ------------------------------
# SUDOERS CONFIGURATION
# From lines 1103-1109
# ------------------------------
read -r -d '' SUDOERS_WHEEL_CONTENT <<'TEMPLATE_EOF'
## Allow members of group wheel to execute any command
%wheel ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command without password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL
TEMPLATE_EOF

# ------------------------------
# ZFSBOOTMENU CONFIGURATION
# From lines 1120-1133
# ------------------------------
read -r -d '' ZBM_CONFIG_CONTENT <<'TEMPLATE_EOF'
Global:
  ManageImages: true
  BootMountPoint: /boot/efi
  DracutConfDir: /etc/zfsbootmenu/dracut.conf.d
Components:
  Enabled: false
EFI:
  ImageDir: /boot/efi/EFI/ZBM
  Versions: false
  Enabled: true
Kernel:
  CommandLine: ro quiet loglevel=0 nowatchdog
  Prefix: vmlinuz
TEMPLATE_EOF

# ------------------------------
# ZFSBOOTMENU DRACUT KEYMAP CONFIG
# From lines 1136-1138
# ------------------------------
ZBM_KEYMAP_CONF_CONTENT='install_optional_items+=" /etc/cmdline.d/keymap.conf "'

# ------------------------------
# CMDLINE KEYMAP CONFIGURATION
# From lines 1141-1143
# ------------------------------
CMDLINE_KEYMAP_CONF_CONTENT='rd.vconsole.keymap=us'

# ============================================
# VALIDATION ARRAYS
# Used by health check script for property validation
# ============================================

# Expected pool properties
EXPECTED_POOL_PROPERTY_ASHIFT="$POOL_ASHIFT"
EXPECTED_POOL_PROPERTY_AUTOTRIM="$POOL_AUTOTRIM"

# Expected dataset properties
EXPECTED_DATASET_PROPERTY_ACLTYPE="$DATASET_ACLTYPE"
EXPECTED_DATASET_PROPERTY_COMPRESSION="$DATASET_COMPRESSION"
EXPECTED_DATASET_PROPERTY_RELATIME="$DATASET_RELATIME"
EXPECTED_DATASET_PROPERTY_XATTR="$DATASET_XATTR"
EXPECTED_DATASET_PROPERTY_DNODESIZE="$DATASET_DNODESIZE"
EXPECTED_DATASET_PROPERTY_NORMALIZATION="$DATASET_NORMALIZATION"
EXPECTED_DATASET_PROPERTY_DEVICES="$DATASET_DEVICES"

# Expected root dataset properties
EXPECTED_ROOT_PROPERTY_MOUNTPOINT="$BOOT_ENV_MOUNTPOINT"
EXPECTED_ROOT_PROPERTY_CANMOUNT="$BOOT_ENV_CANMOUNT"
EXPECTED_ROOT_PROPERTY_RECORDSIZE="$BOOT_ENV_RECORDSIZE"
EXPECTED_ROOT_PROPERTY_ATIME="$BOOT_ENV_ATIME"
EXPECTED_ROOT_PROPERTY_RELATIME="$BOOT_ENV_RELATIME"

# Expected home dataset properties
EXPECTED_HOME_PROPERTY_MOUNTPOINT="$HOME_DATASET_MOUNTPOINT"
EXPECTED_HOME_PROPERTY_RECORDSIZE="$HOME_DATASET_RECORDSIZE"
EXPECTED_HOME_PROPERTY_COMPRESSION="$HOME_DATASET_COMPRESSION"
EXPECTED_HOME_PROPERTY_ATIME="$HOME_DATASET_ATIME"

# ============================================
# END OF CONFIGURATION
# ============================================

return 0
