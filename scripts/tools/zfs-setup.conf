# ZFS Scripts Configuration File
# Location: /etc/zfs-setup.conf
# Version: 1.4
# Description: Central configuration for all ZFS management scripts
#
# This file contains all paths, settings, and configurations used by:
# - voidZFSInstallRepo.sh (installation)
# - zfs-health-check.sh (health monitoring)
# - zfs-services-manager.sh (service management)
# - zfs-pre-checks.sh (pre-update validation)
# - zfs-install-updates.sh (system updates)
#
# IMPORTANT: Do not modify unless you know what you're doing!
# Changes here affect ALL ZFS management scripts.

# ============================================
# SCRIPT METADATA
# ============================================
CONFIG_VERSION="1.4"
CONFIG_DATE="2025-12-08"
CONFIG_NAME="zfs-setup.conf"

# ============================================
# ZFS CORE FILE PATHS
# ============================================
# ZFS encryption key file
# Used for encrypted pool/dataset access
# Permission: 400 (root read-only)
ZFS_KEY_FILE="/etc/zfs/zroot.key"

# ZFS pool cache file
# Contains imported pool information
# Auto-generated by ZFS on pool import
# Permission: 644 (root read/write, others read)
ZFS_CACHE_FILE="/etc/zfs/zpool.cache"

# System host ID file
# Critical for ZFS pool import
# Must be exactly 4 bytes
# Generated by: zgenhostid
ZFS_HOSTID_FILE="/etc/hostid"

# ZFS key backup directory
# Store backup copies of encryption keys
# Permission: 700 (root only)
ZFS_KEY_BACKUP_DIR="/root/zfs-keys"

# ZFS configuration directory
ZFS_CONFIG_DIR="/etc/zfs"

# ============================================
# ZFS POOL DEFAULTS
# ============================================
# Default pool name for installation
DEFAULT_POOL_NAME="zroot"

# Default encryption algorithm
# Options: aes-128-ccm, aes-192-ccm, aes-256-ccm, aes-128-gcm, aes-192-gcm, aes-256-gcm
ENCRYPTION_ALGORITHM="aes-256-gcm"

# Key format
# Options: raw, hex, passphrase
KEY_FORMAT="passphrase"

# Key location for native encryption
KEY_LOCATION="prompt"

# ============================================
# ZFSBOOTMENU PATHS
# ============================================
# ZFSBootMenu main configuration file
# YAML format configuration
ZBM_CONFIG="/etc/zfsbootmenu/config.yaml"

# ZFSBootMenu configuration directory
ZBM_CONFIG_DIR="/etc/zfsbootmenu"

# ZFSBootMenu dracut configuration directory
# Contains additional dracut modules for ZBM
ZBM_DRACUT_DIR="/etc/zfsbootmenu/dracut.conf.d"

# ZFSBootMenu keymap configuration
# Keyboard layout for boot menu
ZBM_KEYMAP_CONF="${ZBM_DRACUT_DIR}/keymap.conf"

# EFI System Partition mount point
# Must be mounted for bootloader operations
ESP_MOUNT="/boot/efi"

# ZFSBootMenu EFI directory
# Contains bootloader images
ZBM_EFI_DIR="${ESP_MOUNT}/EFI/ZBM"

# ZFSBootMenu primary EFI image
# Main bootloader kernel+initramfs bundle
ZBM_EFI_IMAGE="${ZBM_EFI_DIR}/vmlinuz.efi"

# ZFSBootMenu backup EFI image
# Fallback bootloader image
ZBM_EFI_BACKUP="${ZBM_EFI_DIR}/vmlinuz-backup.efi"

# ZFSBootMenu components directory
# Generated ZBM components
ZBM_COMPONENTS_DIR="${ESP_MOUNT}/EFI/ZBM"

# ============================================
# DRACUT CONFIGURATION PATHS
# ============================================
# Dracut main configuration file
# Global dracut settings
DRACUT_MAIN_CONF="/etc/dracut.conf"

# Dracut configuration directory
# Drop-in configuration files
DRACUT_CONF_DIR="/etc/dracut.conf.d"

# Dracut ZFS-specific configuration
# ZFS module and options
DRACUT_ZFS_CONF="${DRACUT_CONF_DIR}/zfs.conf"

# Dracut module directory
# Contains dracut modules
DRACUT_MODULE_DIR="/usr/lib/dracut/modules.d"

# ============================================
# BOOT CONFIGURATION PATHS
# ============================================
# Boot directory
# Contains kernel and initramfs images
BOOT_DIR="/boot"

# Kernel command line directory
# Persistent kernel parameters
CMDLINE_DIR="/etc/cmdline.d"

# Kernel command line keymap config
# Boot-time keyboard layout
CMDLINE_KEYMAP="${CMDLINE_DIR}/keymap.conf"

# Initramfs naming pattern
# Pattern: initramfs-<kernel-version>.img
INITRAMFS_PATTERN="${BOOT_DIR}/initramfs-*.img"

# Kernel naming pattern
# Pattern: vmlinuz-<kernel-version>
KERNEL_PATTERN="${BOOT_DIR}/vmlinuz-*"

# ============================================
# RUNIT SERVICE PATHS (Void Linux)
# ============================================
# Runit service directory
# Service definitions
SERVICE_DIR="/etc/sv"

# Runit runsvdir
# Active services (symlinks)
RUNSVDIR="/var/service"

# ZFS services (in order of dependency)
ZFS_SERVICES=(
    "zfs-import"
    "zfs-mount"
    "zfs-share"
    "zfs-zed"
)

# Optional ZFS services
ZFS_OPTIONAL_SERVICES=(
    "zfs-trim"
    "zfs-scrub"
)

# ============================================
# LOGGING PATHS
# ============================================
# Default log directory for ZFS scripts
ZFS_LOG_DIR="/var/log/zfs-scripts"

# Installation log file
INSTALL_LOG_FILE="${ZFS_LOG_DIR}/installation.log"

# Health check log file
HEALTH_CHECK_LOG_FILE="${ZFS_LOG_DIR}/health-check.log"

# Update log file
UPDATE_LOG_FILE="${ZFS_LOG_DIR}/updates.log"

# ============================================
# DRACUT CONFIGURATION CONTENT
# ============================================
# This section contains the actual configuration content
# that will be written to dracut configuration files

# Dracut ZFS configuration content (for /etc/dracut.conf.d/zfs.conf)
# Reference: https://man.archlinux.org/man/dracut.conf.5
read -r -d '' DRACUT_ZFS_CONFIG_CONTENT <<'EOF'
# Dracut ZFS Configuration
# Generated by ZFS installation scripts
# Reference: https://man.archlinux.org/man/dracut.conf.5

# Host-only mode: only include modules/files needed for this system
# Reduces initramfs size significantly
hostonly="yes"

# Don't include host-specific command line in initramfs
# We want flexibility to boot with different parameters
hostonly_cmdline="no"

# Skip filesystem check (fsck)
# ZFS handles its own integrity checking
nofsck="yes"

# Add ZFS dracut module
# This includes all ZFS tools in initramfs
add_dracutmodules+=" zfs "

# Omit unnecessary filesystem modules
# Reduces initramfs size and boot time
omit_dracutmodules+=" btrfs resume "

# Install critical files into initramfs
# These are required for ZFS pool import
install_items+=" /etc/zfs/zroot.key /etc/hostid "

# Force include ZFS kernel module
# Ensures ZFS is available at boot
force_drivers+=" zfs "

# Declare ZFS as filesystem type
# Required for proper ZFS handling
filesystems+=" zfs "
EOF

# Dracut main configuration content (for /etc/dracut.conf)
# Reference: https://man.archlinux.org/man/dracut.conf.5
read -r -d '' DRACUT_MAIN_CONFIG_CONTENT <<'EOF'
# Dracut Main Configuration
# Global settings for dracut
# Reference: https://man.archlinux.org/man/dracut.conf.5

# Host-only mode: only include modules/files needed for this system
hostonly="yes"

# Compression method for initramfs
# Options: gzip, bzip2, lzma, xz, lzo, lz4, zstd
# zstd provides excellent compression with reasonable decompression speed
compress="zstd"

# Add ZFS kernel module
add_drivers+=" zfs "

# Omit unnecessary modules to reduce initramfs size
omit_dracutmodules+=" network plymouth "
EOF

# ZFSBootMenu dracut keymap configuration content
# Sets keyboard layout for ZFSBootMenu interface
read -r -d '' ZBM_KEYMAP_CONFIG_CONTENT <<'EOF'
# ZFSBootMenu Keymap Configuration
# Sets keyboard layout for boot menu
# Reference: https://docs.zfsbootmenu.org/en/latest/general/bootloader-integration.html

# Include keymap configuration in initramfs
install_optional_items+=" /etc/cmdline.d/keymap.conf "
EOF

# Kernel command line keymap configuration
# Persistent kernel parameters for keyboard layout
read -r -d '' CMDLINE_KEYMAP_CONTENT <<'EOF'
# Kernel Command Line Keymap Configuration
# Persistent kernel parameters
# Reference: https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html

# Set console keyboard layout
# Replace 'us' with your layout (e.g., 'de', 'fr', 'uk')
rd.vconsole.keymap=us
EOF

# ============================================
# ZFSBOOTMENU CONFIGURATION CONTENT
# ============================================
# ZFSBootMenu main configuration (YAML)
# Reference: https://docs.zfsbootmenu.org/en/latest/general/configure.html

read -r -d '' ZBM_CONFIG_CONTENT <<'EOF'
# ZFSBootMenu Configuration
# Reference: https://docs.zfsbootmenu.org/en/latest/general/configure.html
---
Global:
  ManageImages: true
  BootMountPoint: /boot/efi
  DracutConfDir: /etc/zfsbootmenu/dracut.conf.d
  PreHooksDir: /etc/zfsbootmenu/pre-hooks.d
  PostHooksDir: /etc/zfsbootmenu/post-hooks.d
  InitCPIOHookDirs: /etc/zfsbootmenu/initcpio.d

Components:
  Enabled: false

Kernel:
  CommandLine: ro quiet loglevel=3

EFI:
  Enabled: true
  ImageDir: /boot/efi/EFI/ZBM
  Versioned: false

syslinux:
  Enabled: false

Backup:
  Target: /boot/efi/EFI/ZBM
  Enabled: true
EOF

# ============================================
# SYSTEM CONFIGURATION CONTENT
# ============================================
# These are configurations written during system installation

# IWD (iNet Wireless Daemon) configuration
read -r -d '' IWD_MAIN_CONFIG <<'EOF'
[General]
UseDefaultInterface=true
EnableNetworkConfiguration=true

[Network]
NameResolvingService=resolvconf
EOF

# Resolvconf configuration
read -r -d '' RESOLVCONF_CONFIG <<'EOF'
resolv_conf=/etc/resolv.conf
name_servers="1.1.1.1 9.9.9.9"
EOF

# Sysctl configuration (networking)
read -r -d '' SYSCTL_CONFIG <<'EOF'
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
EOF

# Useradd defaults
read -r -d '' USERADD_DEFAULTS <<'EOF'
# Default values for useradd
GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
CREATE_MAIL_SPOOL=yes
EOF

# Sudoers configuration for wheel group
read -r -d '' SUDOERS_WHEEL <<'EOF'
## Allow members of group wheel to execute any command
%wheel ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command without password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL
EOF

# ============================================
# USER CONFIGURATION SCRIPT TEMPLATE
# ============================================
# Script template for configuring users in chroot environment
# Variables to be replaced: $ROOT_PASSWORD, $USERNAME, $USER_PASSWORD
read -r -d '' CONFIGURE_USERS_SCRIPT_TEMPLATE <<'EOFTEMPLATE'
#!/bin/bash
# User Configuration Script
# Generated by ZFS installation
set -e

# Set root password
echo "root:__ROOT_PASSWORD__" | chpasswd

# Create user
useradd -m -G wheel,audio,video,input "__USERNAME__"
echo "__USERNAME__:__USER_PASSWORD__" | chpasswd

# Set ownership of home directory
chown -R "__USERNAME__:__USERNAME__" "/home/__USERNAME__"

# Set proper permissions
chmod 700 "/home/__USERNAME__"
EOFTEMPLATE

# ============================================
# FSTAB TEMPLATE
# ============================================
# fstab configuration template
# Variables to be replaced: $EFI_UUID, $ESP_MOUNT, $DEFAULT_POOL_NAME
read -r -d '' FSTAB_TEMPLATE <<'EOFTEMPLATE'
# /etc/fstab: static file system information
# Generated by ZFS installation scripts
#
# <file system>              <mount point>  <type>  <options>                        <dump> <pass>

# EFI System Partition
UUID=__EFI_UUID__            __ESP_MOUNT__  vfat    defaults,noatime                 0      2

# Temporary filesystems
tmpfs                        /tmp           tmpfs   defaults,nosuid,nodev,mode=1777  0      0
tmpfs                        /dev/shm       tmpfs   defaults,nosuid,nodev,noexec     0      0
EOFTEMPLATE

# Fstab swap entry template (appended if swap is configured)
# Variables to be replaced: $DEFAULT_POOL_NAME
read -r -d '' FSTAB_SWAP_TEMPLATE <<'EOFTEMPLATE'

# ZFS swap volume
/dev/zvol/__POOL_NAME__/swap none           swap    discard,pri=100                  0      0
EOFTEMPLATE

# ============================================
# VALIDATION
# ============================================
# Validate that critical paths exist (for runtime checks)
validate_zfs_paths() {
    local failed=0
    
    # Check if running in installation mode (paths won't exist yet)
    if [[ -n "${ZFS_INSTALL_MODE:-}" ]]; then
        return 0
    fi
    
    # Check critical files
    if [[ ! -f "$ZFS_HOSTID_FILE" ]]; then
        echo "WARNING: $ZFS_HOSTID_FILE not found"
        failed=1
    fi
    
    if [[ ! -d "$ZFS_CONFIG_DIR" ]]; then
        echo "WARNING: $ZFS_CONFIG_DIR not found"
        failed=1
    fi
    
    return $failed
}

# ============================================
# INITIALIZATION
# ============================================
# Log that configuration was loaded
if command -v debug >/dev/null 2>&1; then
    debug "zfs-setup.conf v${CONFIG_VERSION} loaded successfully"
fi

# Return success
return 0
